{% extends "base.html" %}

{% block title %}{{ card.name }} MTG Card Strategy{% endblock %}

{% block content %}
<script>
  window.CURRENT_CARD_UUID = "{{ card.uuid }}";
  window.CURRENT_CARD_NAME = "{{ card.name|e }}";
</script>
<div class="container mt-4">
    <div class="row">
        <!-- Card Image and Details Column -->
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <div class="bg-light text-center p-2">
                    <img 
                        src="{{ card.imageUris.normal if card.imageUris and card.imageUris.normal else url_for('static', filename='img/cardback.png') }}" 
                        class="img-fluid rounded" 
                        alt="{{ card.name }}"
                        style="max-height: 340px; object-fit: contain;"
                    >
                </div>
                <div class="card-body" id="card-details-panel">
                    <h4 class="card-title mb-2">{{ card.name }}</h4>
                    <div class="mb-2">
                        <span class="badge bg-secondary me-1">{{ card.set_name or card.set|upper or "Unknown Set" }}</span>
                        <span class="badge bg-info text-dark">{{ card.rarity|capitalize }}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Mana Cost:</strong>
                        <span class="ms-1">{{ card.mana_cost or "—" }}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Type:</strong>
                        <span class="ms-1">{{ card.type_line or "—" }}</span>
                    </div>
                    {% if card.power or card.toughness %}
                    <div class="mb-2">
                        <strong>P/T:</strong>
                        <span class="ms-1">{{ card.power or "?" }}/{{ card.toughness or "?" }}</span>
                    </div>
                    {% endif %}
                    {% if card.oracle_text %}
                    <div class="mb-2">
                        <strong>{{ card.name }} Text:</strong>
                        <div class="small text-muted" style="white-space: pre-line;">{{ card.oracle_text }}</div>
                    </div>
                    {% endif %}
                    {% if card.flavor_text %}
                    <div class="mb-2">
                        <strong>Flavor:</strong>
                        <div class="fst-italic small text-secondary" style="white-space: pre-line;">{{ card.flavor_text }}</div>
                    </div>
                    {% endif %}
                    {% if card.artist %}
                    <div class="mb-2">
                        <strong>Artist:</strong>
                        <span class="ms-1">{{ card.artist }}</span>
                    </div>
                    {% endif %}
                    <div class="mb-2">
                        <strong>World Average Price:</strong>
                        {% set usd = card.prices.usd|float if card.prices and card.prices.usd else None %}
                        {% set eur = card.prices.eur|float if card.prices and card.prices.eur else None %}
                        {% if usd is not none and eur is not none %}
                            <span class="ms-1">${{ '%.2f' % ((usd + eur)/2) }} (avg of ${{ '%.2f' % usd }} &amp; €{{ '%.2f' % eur }})</span>
                        {% elif usd is not none %}
                            <span class="ms-1">${{ '%.2f' % usd }}</span>
                        {% elif eur is not none %}
                            <span class="ms-1">€{{ '%.2f' % eur }}</span>
                        {% else %}
                            <span class="ms-1">—</span>
                        {% endif %}
                    </div>
                    {% if card.prices.usd_foil or card.prices.eur_foil %}
                    <div class="mb-2">
                        <strong>Foil Price:</strong>
                        {% set usd_foil = card.prices.usd_foil|float if card.prices and card.prices.usd_foil else None %}
                        {% set eur_foil = card.prices.eur_foil|float if card.prices and card.prices.eur_foil else None %}
                        {% if usd_foil is not none and eur_foil is not none %}
                            <span class="ms-1">${{ '%.2f' % ((usd_foil + eur_foil)/2) }} (avg of ${{ '%.2f' % usd_foil }} &amp; €{{ '%.2f' % eur_foil }})</span>
                        {% elif usd_foil is not none %}
                            <span class="ms-1">${{ '%.2f' % usd_foil }}</span>
                        {% elif eur_foil is not none %}
                            <span class="ms-1">€{{ '%.2f' % eur_foil }}</span>
                        {% else %}
                            <span class="ms-1">—</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="mb-2">
                        <strong>Collector Number:</strong>
                        <span class="ms-1">{{ card.collector_number or "—" }}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Release Date:</strong>
                        <span class="ms-1">{{ card.released_at or "—" }}</span>
                    </div>
                    <div class="mb-2">
                        <strong>Legalities:</strong>
                        <span class="ms-1">{{ card.legalities | dictsort if card.legalities else "—" }}</span>
                    </div>
                    {% if card.imageUris and card.imageUris.art_crop %}
                    <div class="mb-2">
                        <img src="{{ card.imageUris.art_crop }}" alt="Art crop" class="img-fluid rounded" style="max-height: 80px;">
                    </div>
                    {% endif %}
                    <!-- Rulings Accordion (async loaded) -->
                    <div id="rulings-accordion" class="mt-3"></div>
                </div>
{% block scripts %}
{{ super() }}
<script>
// --- Async Scryfall Rulings Fetch ---
document.addEventListener('DOMContentLoaded', function() {
    const scryfallId = "{{ card.scryfall_id }}";
    if (!scryfallId || scryfallId === 'null' || scryfallId === '') return;
    if (!scryfallId) return;
    fetch(`https://api.scryfall.com/cards/${scryfallId}/rulings`)
        .then(resp => resp.json())
        .then(data => {
            if (!data || !data.data || !Array.isArray(data.data) || data.data.length === 0) return;
            const rulings = data.data;
            let html = `<div class="accordion" id="rulingsAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingRulings">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRulings" aria-expanded="false" aria-controls="collapseRulings">
        Card Rulings
      </button>
    </h2>
    <div id="collapseRulings" class="accordion-collapse collapse" aria-labelledby="headingRulings" data-bs-parent="#rulingsAccordion">
      <div class="accordion-body">
        <ul class="list-unstyled mb-0">`;
            for (const r of rulings) {
                html += `<li class="mb-2"><span class="text-muted small">${r.published_at}:</span> ${r.comment}</li>`;
            }
            html += `</ul>
      </div>
    </div>
  </div>
</div>`;
            document.getElementById('rulings-accordion').innerHTML = html;
        });
});
</script>
{% endblock %}
            </div>
        </div>

        <!-- Analysis Column and Recent Analyses Sidebar -->
        <div class="col-md-8">
            {% if card.analysis %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Full Analysis</h4>
                        {% if card.analysis.analyzed_at %}
                            <small class="text-light">Generated on {{ card.analysis.analyzed_at }}</small>
                        {% endif %}
                    </div>
                    <div class="card-body markdown-content">
                        {{ card.analysis.long_form | link_card_mentions(current_card_name) | markdown | safe }}
                    </div>
                    {% if card.analysis.native_language_long_form %}
                    <div class="card-body markdown-content border-top mt-4 pt-3">
                        <h5 class="text-secondary">Native Language Analysis</h5>
                        {{ card.analysis.native_language_long_form | markdown | safe }}
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info mb-4">
                    <strong>Analysis not yet available for this card.</strong><br>
                    Check back soon, or explore similar cards below!
                </div>
            {% endif %}
            <!-- Recent Analyses Section -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Recent Analyses</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% for rc in recent_cards %}
                    <li class="list-group-item d-flex align-items-center">
                        <a href="/card/{{ rc.uuid }}" class="me-2">
                            {% if rc.imageUris and rc.imageUris.normal %}
                                <img src="{{ rc.imageUris.normal }}" alt="{{ rc.name }}" style="width:40px; height:56px; object-fit:cover; border-radius:4px;">
                            {% else %}
                                <img src="{{ url_for('static', filename='img/cardback.png') }}" alt="No image" style="width:40px; height:56px; object-fit:cover; border-radius:4px;">
                            {% endif %}
                        </a>
                        <a href="/card/{{ rc.uuid }}">{{ rc.name }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}